{
  "schemaVersion": 1,
  "items": {
    "agent-questions": {
      "id": "agent-questions",
      "title": "Handle Agent Clarifying Questions",
      "description": "Implement TUI handling for agent clarifying questions during plan generation, allowing users to answer questions in a modal dialog.",
      "acceptanceCriteria": [
        "When agent returns questions, display them in a new modal or dialog",
        "Modal shows question text and options (if provided)",
        "User can input answers (text or select from options)",
        "Answers are sent back to agent to continue generation",
        "Multiple question rounds are supported (up to maxAgentQuestionRounds)"
      ],
      "prompt": "Implement agent question handling in the TUI. When the plan generation agent returns questions (agent.Response with Questions field), display them in a modal dialog. For questions with options, show numbered choices like the CLI does. For free-text questions, show a text input. Collect the user's answers and re-invoke the agent with the answers included. Support multiple rounds of questions up to the configured limit (maxAgentQuestionRounds). This should integrate with the existing in-memory command flow.",
      "parentId": null,
      "childIds": [],
      "deps": [
        "in-memory-command",
        "spinner-progress"
      ],
      "status": "done",
      "createdAt": "2026-01-28T00:00:00Z",
      "updatedAt": "2026-01-29T02:59:26.767674Z",
      "depRationale": {
        "in-memory-command": "Questions come from the agent command, so the command infrastructure must exist first",
        "spinner-progress": "Question handling extends the progress flow, so basic progress handling should be in place"
      }
    },
    "in-memory-command": {
      "id": "in-memory-command",
      "title": "Implement In-Memory Plan Generation Command",
      "description": "Create a new command execution path that runs plan generation without spawning a subprocess, using the agent runtime directly with programmatically provided inputs instead of stdin prompts.",
      "acceptanceCriteria": [
        "New function in action_wrappers.go that calls agent runtime directly (no subprocess)",
        "Function accepts description, constraints, granularity as parameters",
        "Agent question/answer loop is handled programmatically without CLI prompts",
        "Function returns agent response (plan/patch/questions) or error",
        "No dependency on stdin/stdout for interactive prompts"
      ],
      "prompt": "Create a new function in internal/tui/action_wrappers.go (e.g., GeneratePlanInMemory) that directly invokes the agent runtime for plan generation without spawning a subprocess. This function should accept the three input parameters (description, constraints, granularity) and call the agent API similar to how internal/cli/agent_flows.go:runPlanGenerate works, but without any interactive prompting. Handle agent questions by either auto-rejecting them or storing them for TUI display. Return the agent response (plan, patch, or questions) as a Bubble Tea message.",
      "parentId": null,
      "childIds": [],
      "deps": [],
      "status": "done",
      "createdAt": "2026-01-28T00:00:00Z",
      "updatedAt": "2026-01-29T02:46:29.146906Z"
    },
    "modal-form": {
      "id": "modal-form",
      "title": "Create Plan Generation Modal Form",
      "description": "Build a Bubble Tea modal component that captures plan generation inputs (project description, constraints, granularity) with multi-line text input support and proper validation.",
      "acceptanceCriteria": [
        "Modal displays when 'g' key is pressed",
        "Form includes fields for project description (required, multi-line), constraints (optional, multi-line), and granularity (optional, single-line)",
        "Modal has navigation between fields (Tab/Enter to advance, Shift+Tab to go back)",
        "ESC key cancels and closes modal without action",
        "Submit button/action validates required fields before proceeding",
        "Modal is properly styled and centered on screen using lipgloss"
      ],
      "prompt": "Create a new modal form component in the TUI that captures the three inputs needed for plan generation: project description (required, multi-line textarea), constraints (optional, multi-line textarea displayed as comma-separated), and granularity (optional, single-line input). The modal should follow the same styling patterns as the existing set-status modal, with keyboard navigation between fields and ESC to cancel. Use charmbracelet/bubbles textarea or textinput components for the form fields.",
      "parentId": null,
      "childIds": [],
      "deps": [],
      "status": "done",
      "createdAt": "2026-01-28T00:00:00Z",
      "updatedAt": "2026-01-29T02:50:31.316716Z"
    },
    "modal-integration": {
      "id": "modal-integration",
      "title": "Integrate Modal into TUI Model",
      "description": "Wire the plan generation modal into the TUI's Model, Update, and View methods to handle the new action mode and keyboard flow.",
      "acceptanceCriteria": [
        "New ActionMode value added (e.g., ActionGeneratePlan)",
        "Pressing 'g' in normal mode transitions to ActionGeneratePlan mode and shows modal",
        "Modal key events are routed to modal component in Update method",
        "Modal is rendered as overlay in View method when action mode is active",
        "Submitting modal captures form data and transitions to command execution"
      ],
      "prompt": "Integrate the plan generation modal into the TUI's core model (internal/tui/model.go). Add a new ActionMode constant for the generate plan modal. Update the Update() method to handle 'g' key press by transitioning to the modal mode, and route subsequent key events to the modal component. Update the View() method to render the modal as an overlay when in ActionGeneratePlan mode, similar to how ActionSetStatus modal is rendered.",
      "parentId": null,
      "childIds": [],
      "deps": [
        "modal-form"
      ],
      "status": "done",
      "createdAt": "2026-01-28T00:00:00Z",
      "updatedAt": "2026-01-29T02:51:06.228728Z",
      "depRationale": {
        "modal-form": "Modal component must exist before it can be integrated into the main TUI model"
      }
    },
    "overwrite-check": {
      "id": "overwrite-check",
      "title": "Add Existing Plan Overwrite Confirmation",
      "description": "Check if a plan already exists before starting generation and prompt user to confirm overwrite, preventing accidental data loss.",
      "acceptanceCriteria": [
        "Before showing generation modal, check if plan.json exists and has items",
        "If plan exists, show confirmation dialog with item count",
        "User can confirm overwrite or cancel",
        "Canceling returns to normal view without showing generation modal",
        "Confirming proceeds to show generation modal normally"
      ],
      "prompt": "Add a pre-check before showing the plan generation modal. When 'g' is pressed, first check if the current plan (model.plan) has any items. If it does, show a confirmation modal asking 'Plan already exists with N items. Overwrite?' with Yes/No options. Only proceed to the generation modal if the user confirms. This prevents accidental overwrites of existing work, matching the CLI's behavior in agent_flows.go:runPlanGenerate.",
      "parentId": null,
      "childIds": [],
      "deps": [
        "modal-integration"
      ],
      "status": "done",
      "createdAt": "2026-01-28T00:00:00Z",
      "updatedAt": "2026-01-29T02:53:24.283712Z",
      "depRationale": {
        "modal-integration": "Overwrite check needs to intercept the modal flow, so modal integration must exist first"
      }
    },
    "plan-review": {
      "id": "plan-review",
      "title": "Implement Plan Review and Revision Flow",
      "description": "Add UI flow to review the generated plan with options to accept, revise, or reject, matching the CLI's review loop functionality.",
      "acceptanceCriteria": [
        "After agent returns plan, display summary and tree preview",
        "Show action choices: Accept, Revise, Reject",
        "Accept option saves plan and returns to normal TUI view",
        "Revise option prompts for revision request and re-runs agent (1 revision allowed)",
        "Reject option discards plan and returns to normal view",
        "Plan is displayed in a scrollable view or separate screen"
      ],
      "prompt": "Implement the plan review and revision flow in the TUI. When the agent successfully generates a plan, display it with a summary (item count, top-level features) and a tree preview. Show three options: Accept (saves plan and reloads TUI), Revise (prompts for changes and re-runs agent once), or Reject (cancels and returns to previous state). The revision flow should allow the user to enter a text description of desired changes, then re-invoke the agent with a refine request. This mirrors the CLI's review loop in agent_flows.go but adapted for the TUI interaction model.",
      "parentId": null,
      "childIds": [],
      "deps": [
        "spinner-progress",
        "agent-questions"
      ],
      "status": "done",
      "createdAt": "2026-01-28T00:00:00Z",
      "updatedAt": "2026-01-29T03:04:54.573748Z",
      "depRationale": {
        "agent-questions": "Revision may trigger more agent questions, so question handling should be in place",
        "spinner-progress": "Plan review happens after plan generation completes, so generation flow must be working"
      }
    },
    "spinner-progress": {
      "id": "spinner-progress",
      "title": "Add Spinner and Progress Feedback",
      "description": "Show spinner animation and status message in the bottom bar while plan generation is running, and handle the response when the agent completes.",
      "acceptanceCriteria": [
        "Spinner animates in bottom bar with message 'Generating plan...'",
        "actionInProgress flag is set during generation",
        "Model receives agent response message when generation completes",
        "Success response updates the plan and clears spinner",
        "Error response displays error message in ActionOutput"
      ],
      "prompt": "Update the TUI to show progress feedback during plan generation. When the modal is submitted and GeneratePlanInMemory command is dispatched, set actionInProgress=true and actionName='Generating plan...' to show the spinner. Define a new message type (e.g., planGenerateResultMsg) to receive the agent response. In the Update method, handle this message by updating the model's plan on success or showing an error ActionOutput on failure, then clearing the spinner and action mode.",
      "parentId": null,
      "childIds": [],
      "deps": [
        "modal-integration",
        "in-memory-command"
      ],
      "status": "done",
      "createdAt": "2026-01-28T00:00:00Z",
      "updatedAt": "2026-01-29T02:54:46.252942Z",
      "depRationale": {
        "in-memory-command": "In-memory command must exist to have something to show progress for",
        "modal-integration": "Modal must be integrated before we can handle its submission"
      }
    },
    "test-validation": {
      "id": "test-validation",
      "title": "Test and Validate Complete Flow",
      "description": "Comprehensive end-to-end testing of the plan generation modal feature, including edge cases and error scenarios.",
      "acceptanceCriteria": [
        "Can open modal with 'g', enter inputs, and submit successfully",
        "Spinner shows during generation and clears on completion",
        "Generated plan is displayed correctly in tree view after acceptance",
        "Agent questions are displayed and answered correctly",
        "Plan revision works and re-runs agent with changes",
        "Overwrite confirmation prevents accidental data loss",
        "ESC key cancels modal at each stage without side effects",
        "Error scenarios (agent failure, invalid input) display appropriate messages",
        "All keyboard shortcuts continue to work after using modal"
      ],
      "prompt": "Perform comprehensive testing of the plan generation modal feature. Test the full happy path: press 'g', fill in form, submit, answer any agent questions, review plan, accept/revise. Test edge cases: ESC at each stage, empty inputs, very long inputs, agent errors, network timeouts. Test with existing plan (overwrite prompt). Verify all error messages are clear and the TUI remains stable. Test that other TUI features (tree navigation, execute, set-status) still work correctly after using the modal. Document any bugs found and fix them.",
      "parentId": null,
      "childIds": [],
      "deps": [
        "modal-form",
        "modal-integration",
        "in-memory-command",
        "spinner-progress",
        "agent-questions",
        "plan-review",
        "overwrite-check"
      ],
      "status": "done",
      "createdAt": "2026-01-28T00:00:00Z",
      "updatedAt": "2026-01-29T03:14:06.514662Z",
      "depRationale": {
        "agent-questions": "All components must be implemented before testing",
        "in-memory-command": "All components must be implemented before testing",
        "modal-form": "All components must be implemented before testing",
        "modal-integration": "All components must be implemented before testing",
        "overwrite-check": "All components must be implemented before testing",
        "plan-review": "All components must be implemented before testing",
        "spinner-progress": "All components must be implemented before testing"
      }
    }
  }
}
